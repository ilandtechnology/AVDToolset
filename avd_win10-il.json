// AVDWin10woM365G1v1
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "imageTemplates_AVDWin10woM365G1v1_name": {
            "defaultValue": "AVDWin10woM365G1v1",
            "type": "String"
        },
        "galleries_galavdbrs_externalid": {
            "defaultValue": "/subscriptions/2eb1e34c-b61d-4910-b8d4-7dd764e910da/resourceGroups/rg-avd-tst-001/providers/microsoft.compute/galleries/galavdbrs",
            "type": "String"
        },
        "virtualNetworks_vnet_tst_eus2_001_externalid": {
            "defaultValue": "/subscriptions/2eb1e34c-b61d-4910-b8d4-7dd764e910da/resourceGroups/rg-shared-tst-001/providers/Microsoft.Network/virtualNetworks/vnet-tst-eus2-001",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.VirtualMachineImages/imageTemplates",
            "apiVersion": "2024-02-01",
            "name": "[parameters('imageTemplates_AVDWin10woM365G1v1_name')]",
            "location": "eastus2",
            "tags": {
                "AVD_IMAGE_TEMPLATE": "AVD_IMAGE_TEMPLATE",
                "BusinessUnit": "shared",
                "ExcludeMdeAutoProvisioning": "true",
                "env": "prod"
            },
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "/subscriptions/2eb1e34c-b61d-4910-b8d4-7dd764e910da/resourcegroups/rg-avd-tst-001/providers/Microsoft.ManagedIdentity/userAssignedIdentities/aibIdentity1723489937": {}
                }
            },
            "properties": {
                "buildTimeoutInMinutes": 0,
                "customize": [
                    {
                        "inline": [
                            "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "Start-Sleep -s 5"
                        ],
                        "name": "checkAgentOnStart",
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\installLanguagePacks.ps1",
                        "name": "avdBuiltInScript_installLanguagePacks",
                        "sha256Checksum": "519f1dcb41c15dc1726f28c51c11fb60876304ab9eb9535e70015cdb704a61b2",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/InstallLanguagePacks.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\installLanguagePacks.ps1 -LanguageList \"Portuguese (Brazil)\""
                        ],
                        "name": "avdBuiltInScript_installLanguagePacks-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_installLanguagePacks-windowsUpdate",
                        "type": "WindowsUpdate",
                        // "searchCriteria": "IsInstalled=0",
                        // "filters": [
                        //     "exclude:$_.Title -like '*KB890830*'",
                        //     "exclude:$_.Title -like '*KB2267602*'",
                        //     "exclude:$_.Title -like '*Preview*'",
                        //     "include:$true"
                        // ],
                        "updateLimit": 0
                    },
                    {
                        "name": "avdBuiltInScript_installLanguagePacks-windowsRestart",
                        "restartTimeout": "10m",
                        "type": "WindowsRestart"
                    },
                    {
                        "inline": [
                            "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "Start-Sleep -s 5"
                        ],
                        "name": "avdBuiltInScript_installLanguagePacks-checkAgentOnStart",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Install Windows Features",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-features.ps1",
                        // "sha256Checksum": "72642af8ddb2bac4c211aa09ea3f53d0ff5fdf6cdb85cbd40812147fb4598942",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Set default OS language",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/SetDefaultLang.ps1",
                        // "sha256Checksum": "97ed90dfea859d08dbcb424aca953c55c2d2b7f8269a5db5b683d4768f6bbd50",
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_windowsRestart",
                        "restartTimeout": "5m",
                        "type": "WindowsRestart"
                    },
                    {
                        "inline": [
                            "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "Start-Sleep -s 5"
                        ],
                        "name": "checkAgentOnStart",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Disable Storage Sense",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/DisableStorageSense.ps1",
                        // "sha256Checksum": "9313511fc0656dc066a4189ffc4815df4dfe13205cb0b8f83b649ae0d0b6c53f",
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_timeZoneRedirection",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/TimezoneRedirection.ps1",
                        "sha256Checksum": "b8dbc50b02f64cc7a99f6eeb7ada676673c9e431255e69f3e7a97a027becd8d5",
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\enableFslogix.ps1",
                        "name": "avdBuiltInScript_enableFsLogix",
                        "sha256Checksum": "027ecbc0bccd42c6e7f8fc35027c55691fba7645d141c9f89da760fea667ea51",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/FSLogix.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\enableFslogix.ps1 -FSLogixInstaller \"https://aka.ms/fslogix_download\" -VHDSize \"512\" -ProfilePath \"\\\\blob\\fslogix\""
                        ],
                        "name": "avdBuiltInScript_enableFsLogix-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_fsLogixKerberos",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/FSLogixKerberos.ps1",
                        "sha256Checksum": "ce83bbcbb2f64f8255bc9f678ab6dba92896b8b1861dd094368c483525541703",
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_configureRdpShortpath",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/RDPShortpath.ps1",
                        "sha256Checksum": "24e9821ddcc63aceba2682286d03cd7042bcadcf08a74fb0a30a1a1cd0cbf910",
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\screenCaptureProtection.ps1",
                        "name": "avdBuiltInScript_screenCaptureProtection",
                        "sha256Checksum": "d8f55ce805123e3519ab373a5fc2c02bf85635717f320a4dfcabab46fb1ecb5e",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/ScreenCaptureProtection.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\screenCaptureProtection.ps1 -block \"BlockBoth\""
                        ],
                        "name": "avdBuiltInScript_removeOfficeApps-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\configureSessionTimeouts.ps1",
                        "name": "avdBuiltInScript_configureSessionTimeouts",
                        "sha256Checksum": "abb1d5ba922013864c94d7a92a5d0aae7ae50805563af2b3777ba9b74ca6ccc4",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/ConfigureSessionTimeoutsV2.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\configureSessionTimeouts.ps1 -MaxDisconnectionTime \"120\" -MaxIdleTime \"120\" -MaxConnectionTime \"0\" -RemoteAppLogoffTimeLimit \"0\""
                        ],
                        "name": "avdBuiltInScript_configureSessionTimeouts-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\multiMediaRedirection.ps1",
                        "name": "avdBuiltInScript_multiMediaRedirection",
                        "sha256Checksum": "f577c9079aaa7da399121879213825a3f263f7b067951a234509e72f8b59a7fd",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/MultiMediaRedirection.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\multiMediaRedirection.ps1 -VCRedistributableLink \"https://aka.ms/vs/17/release/vc_redist.x64.exe\" -EnableEdge \"true\" -EnableChrome \"false\""
                        ],
                        "name": "avdBuiltInScript_multiMediaRedirection-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_disableAutoUpdates",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/DisableAutoUpdates.ps1",
                        "sha256Checksum": "eafd5e46c628b685f2061146550287255d75b7cea63f1e9dd29827c4ff7c3cb4",
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\removeAppxPackages.ps1",
                        "name": "avdBuiltInScript_removeAppxPackages",
                        "sha256Checksum": "422b4c7b961f4d8b4216f126d8f38b00da583748b2d65b835504c1e9a07b0ece",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/RemoveAppxPackages.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\removeAppxPackages.ps1 -AppxPackages \"Clipchamp.Clipchamp\",\"Microsoft.BingNews\",\"Microsoft.BingWeather\",\"Microsoft.GamingApp\",\"Microsoft.GetHelp\",\"Microsoft.Getstarted\",\"Microsoft.MicrosoftOfficeHub\",\"Microsoft.Office.OneNote\",\"Microsoft.MicrosoftSolitaireCollection\",\"Microsoft.MicrosoftStickyNotes\",\"Microsoft.MSPaint\",\"Microsoft.People\",\"Microsoft.PowerAutomateDesktop\",\"Microsoft.ScreenSketch\",\"Microsoft.SkypeApp\",\"Microsoft.Todos\",\"Microsoft.Windows.Photos\",\"Microsoft.WindowsAlarms\",\"Microsoft.WindowsCalculator\",\"Microsoft.WindowsCamera\",\"Microsoft.windowscommunicationsapps\",\"Microsoft.WindowsFeedbackHub\",\"Microsoft.WindowsMaps\",\"Microsoft.WindowsNotepad\",\"Microsoft.WindowsSoundRecorder\",\"Microsoft.WindowsTerminal\",\"Microsoft.Xbox.TCUI\",\"Microsoft.XboxGameOverlay\",\"Microsoft.XboxGamingOverlay\",\"Microsoft.XboxIdentityProvider\",\"Microsoft.XboxSpeechToTextOverlay\",\"Microsoft.YourPhone\",\"Microsoft.ZuneMusic\",\"Microsoft.ZuneVideo\",\"Microsoft.XboxApp\""
                        ],
                        "name": "avdBuiltInScript_removeAppxPackages-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    // {
                    //     "destination": "C:\\AVDImage\\OfficeApps.ps1",
                    //     "name": "avdBuiltInScript_removeOfficeApps",
                    //     "sha256Checksum": "5d80ed2122fcb163d7778735c2101b11fce0f960fd8dd25aec38479212214cf4",
                    //     "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/ConfigureOfficeApps.ps1",
                    //     "type": "File"
                    // },
                    // {
                    //     "inline": [
                    //         "C:\\AVDImage\\OfficeApps.ps1 -Type \"Remove\" -Applications \"Access\",\"OneNote\",\"Outlook\",\"Publisher\" -Version \"64\""
                    //     ],
                    //     "name": "avdBuiltInScript_removeOfficeApps-parameter",
                    //     "runAsSystem": true,
                    //     "runElevated": true,
                    //     "type": "PowerShell"
                    // },
                    {
                        "name": "Install PostgreSQL ODBC component",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-pgodbc.ps1",
                        // "sha256Checksum": "1b76e6c2e5c33cac1ec0080b0b090fbe0cf1ec8b98ae1b989b6f17cf5231caf5",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Install OstroSoft SMTP component",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-ossmtp.ps1",
                        // "sha256Checksum": "66867779a3c3377fb3b35f110179ab515afed9a164aa1d00ed57d275cd9c1774",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Install Crystal Reports XI component",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-crystalreports.ps1",
                        // "sha256Checksum": "c39a3ccfe33f57875496916cf4ce104e0849d51c251c32016726fb9bd6f95778",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Install Interface Plus component",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-interfaceplus.ps1",
                        // "sha256Checksum": "d371231c0602a1c395e407f02de06cb3a87ed161190bad153e08d155ff3c5e96",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Install Epson printer driver",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-prn-epson_tm-t20x.ps1",
                        // "sha256Checksum": "f06d63abffcb54e61d3d3eac83d85e64a815f01be1a59048c37ae0be4d2cc42e",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Install Zebra printer driver",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/deploy-prn-zebra_zd220.ps1",
                        // "sha256Checksum": "a91fd3d1c4db2b4c5d09c3779c314358a0bf5e65f1859c4f64f6f8cc57c2831c",
                        "type": "PowerShell"
                    },
                    {
                        "destination": "C:\\AVDImage\\windowsOptimization.ps1",
                        "name": "avdBuiltInScript_windowsOptimization",
                        "sha256Checksum": "3a84266be0a3fcba89f2adf284f3cc6cc2ac41242921010139d6e9514ead126f",
                        "sourceUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/WindowsOptimization.ps1",
                        "type": "File"
                    },
                    {
                        "inline": [
                            "C:\\AVDImage\\windowsOptimization.ps1 -Optimizations \"WindowsMediaPlayer\",\"ScheduledTasks\",\"DefaultUserSettings\",\"Autologgers\",\"Services\",\"NetworkOptimizations\",\"LGPO\",\"DiskCleanup\",\"Edge\",\"RemoveLegacyIE\",\"RemoveOneDrive\""
                        ],
                        "name": "avdBuiltInScript_windowsOptimization-parameter",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_windowsOptimization-windowsUpdate",
                        "type": "WindowsUpdate",
                        "searchCriteria": "IsInstalled=0",
                        "filters": [
                            "exclude:$_.Title -like '*KB890830*'",
                            "exclude:$_.Title -like '*KB2267602*'",
                            "exclude:$_.Title -like '*Preview*'",
                            "include:$true"
                        ],
                        "updateLimit": 0
                    },
                    {
                        "name": "avdBuiltInScript_windowsOptimization-windowsRestart",
                        "type": "WindowsRestart"
                    },
                    {
                        "inline": [
                            "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "Start-Sleep -s 5"
                        ],
                        "name": "avdBuiltInScript_windowsOptimization-checkAgentOnStart",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Uninstall OneDrive for all users",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/undeploy-onedrive.ps1",
                        // "sha256Checksum": "2bdd09c12e0e1b9d109de0ce4ce4cc6aba45f954763919e29e74c325e8b637e2",
                        "type": "PowerShell"
                    },
                    {
                        "name": "Uninstall Windows Features",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/ilandtechnology/AVDToolset/main/undeploy-features.ps1",
                        // "sha256Checksum": "9cac77a3ac20755fe5e1c44989a49ff5a0e52e21b6d933ae9eba2b9a3ea7c498",
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_windowsUpdate",
                        "type": "WindowsUpdate",
                        "searchCriteria": "IsInstalled=0",
                        "filters": [
                            "exclude:$_.Title -like '*KB890830*'",
                            "exclude:$_.Title -like '*KB2267602*'",
                            "exclude:$_.Title -like '*Preview*'",
                            "include:$true"
                        ],
                        "updateLimit": 0
                    },
                    {
                        "name": "avdBuiltInScript_windowsUpdate-windowsRestart",
                        "type": "WindowsRestart"
                    },
                    {
                        "inline": [
                            "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
                            "Start-Sleep -s 180"
                        ],
                        "name": "avdBuiltInScript_windowsUpdate-checkAgentAgentOnStart",
                        "type": "PowerShell"
                    },
                    {
                        "name": "avdBuiltInScript_adminSysPrep",
                        "runAsSystem": true,
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/AdminSysPrep.ps1",
                        "sha256Checksum": "1dcaba4823f9963c9e51c5ce0adce5f546f65ef6034c364ef7325a0451bd9de9",
                        "type": "PowerShell"
                    }
                ],
                "distribute": [
                    {
                        "type": "SharedImage",
                        "galleryImageId": "[concat(parameters('galleries_galavdbrs_externalid'), '/images/avdwin10wom365g1v1')]",
                        "runOutputName": "win10-22h2-avd-gold", // Win10: win10-22h2-avd-m365-g2-custom / Win11: win11-23h2-avd-m365-g2-custom
                        "artifactTags": {
                            "env": "prod",
                            "BusinessUnit": "shared"
                        },
                        "targetRegions": [
                            {
                            "name": "eastus2",
                            "replicaCount": 1,
                            "storageAccountType": "Standard_LRS"
                            }
                        ],
                        "excludeFromLatest": false,
                        "versioning": {
                            "scheme": "Latest",
                            "major": 1
                        }
                    }
                ],
                "optimize": {
                    "vmBoot": {
                        "state": "Enabled"
                    }
                },
                "source": {
                    "offer": "windows-10",
                    "publisher": "microsoftwindowsdesktop",
                    "sku": "win10-22h2-avd", // win10-22h2-avd-m365 / win10-22h2-avd-m365-g2 / win11-23h2-avd-m365 /// Get-AzVMImageSku -Location eastus2 -PublisherName MicrosoftWindowsDesktop -Offer office-365/Windows-10/Windows-11
                    "type": "PlatformImage",
                    "version": "latest"
                },
                "stagingResourceGroup": "/subscriptions/2eb1e34c-b61d-4910-b8d4-7dd764e910da/resourceGroups/rg-avd-tst-255",
                "vmProfile": {
                    // "osDiskSizeGB": 64, // g1: 64 / g2: 127
                    "vmSize": "Standard_D2as_v5",
                    "vnetConfig": {
                        "subnetId": "[concat(parameters('virtualNetworks_vnet_tst_eus2_001_externalid'), '/subnets/snet-tst-eus2-254')]"
                    }
                }
            }
        }
    ]
}

// New-AzResourceGroupDeployment -ResourceGroupName rg-avd-tst-001 -TemplateFile C:\GitHub\AVDToolset\avd.json
// Start-AzImageBuilderTemplate -ResourceGroupName rg-avd-tst-001 -Name AVDWin10woM365G1v1